<div class="container-fluid py-3">
  <mat-card class="mat-elevation-z2 mb-4">
    <mat-card-content
      class="d-flex justify-content-between align-items-start flex-wrap gap-3 p-4"
    >
      <h1 class="mat-headline-3 mb-1">Créer un événement</h1>
      <p class="mat-body-3 text-muted w-70 mt-1">
        Organisez des événements, ajoutez des médias,
        prévisualisez l'événement sur la page de la structure, enregistrez les
        comme brouillon pour y revenir plus tard.
      </p>
    </mat-card-content>
  </mat-card>
  <mat-stepper class="p-4" [orientation]="(stepperOrientation | async)!">
    <mat-step [stepControl]="eventForm" label="Informations">
      <form [formGroup]="eventForm">
        <div class="row g-3 mb-3 mt-3">
          <div class="col-md-6">
            <mat-form-field appearance="fill" class="w-100">
              <mat-label>Nom de l’événement</mat-label>
              <input
                matInput
                formControlName="name"
                placeholder="Nom de l’événement"
                required
              />
              @if (eventForm.get('name')?.hasError('required') &&
              eventForm.get('name')?.touched) {
              <mat-error>Le nom de l'événement est obligatoire</mat-error>
              }
            </mat-form-field>
          </div>
          <div class="col-md-6">
            <mat-form-field appearance="fill" class="w-100">
              <mat-label>Catégorie</mat-label>
              <mat-select
                formControlName="category"
                placeholder="Sélectionner..."
                required
              >
                @for (cat of categories; track cat) {
                <mat-option [value]="cat">{{ cat }}</mat-option>
                }
              </mat-select>
              @if (eventForm.get('category')?.hasError('required') &&
              eventForm.get('category')?.touched) {
              <mat-error>La catégorie est obligatoire</mat-error>
              }
            </mat-form-field>
          </div>
        </div>

        <div class="row g-3 mb-3">
          <div class="col-md-6">
            <mat-form-field appearance="fill" class="w-100" floatLabel="always">
              <mat-label>Description courte</mat-label>
              <textarea
                matInput
                formControlName="shortDescription"
                placeholder="Décrivez brièvement l'événement..."
                rows="5"
                maxlength="263"
              ></textarea>
              <mat-hint align="end"
                >{{
                  eventForm.get("shortDescription")?.value?.length || 0
                }}/263</mat-hint
              >
              @if (eventForm.get('shortDescription')?.hasError('maxlength') &&
              eventForm.get('shortDescription')?.touched) {
              <mat-error
                >La description ne peut pas dépasser 263 caractères</mat-error
              >
              }
            </mat-form-field>
          </div>
          <div class="col-md-6">
            <mat-form-field appearance="fill" class="w-100">
              <mat-label>Genre</mat-label>
              <input
                matInput
                formControlName="genre"
                placeholder="Ex: Rock, Comédie, Business..."
              />
            </mat-form-field>
            <mat-form-field appearance="fill" class="w-100">
              <mat-label>Tags (séparés par une virgule)</mat-label>
              <input
                matInput
                formControlName="tags"
                placeholder="tag1, tag2, tag3"
              />
              <mat-hint>Facultatif. Aide à la recherche.</mat-hint>
            </mat-form-field>
          </div>
        </div>

        <div class="row g-3 mb-3">
          <div class="col-lg-6 col-md-12">
            <label class="form-label">Début de l'événement</label>
            <div class="row g-2 align-items-center">
              <div class="col-sm-7">
                <mat-form-field appearance="fill" class="w-100">
                  <mat-label>Date de début</mat-label>
                  <input
                    matInput
                    [matDatepicker]="startDatePicker"
                    formControlName="startDate"
                    placeholder="Choisir une date"
                    required
                  />
                  <mat-datepicker-toggle
                    matSuffix
                    [for]="startDatePicker"
                    color="primary"
                  ></mat-datepicker-toggle>
                  <mat-datepicker
                    #startDatePicker
                    color="primary"
                    [touchUi]="!isDesktop$()"
                  ></mat-datepicker>
                  @if (eventForm.get('startDate')?.hasError('required') &&
                  eventForm.get('startDate')?.touched) {
                  <mat-error>La date de début est obligatoire</mat-error>
                  }
                </mat-form-field>
              </div>
              <div class="col-sm-5">
                <mat-form-field appearance="fill" class="w-100">
                  <mat-label>Heure de début</mat-label>
                  <input
                    matInput
                    formControlName="startTime"
                    required
                    [matTimepicker]="startTimePicker"
                  />
                  <mat-timepicker-toggle
                    matIconSuffix
                    [for]="startTimePicker"
                  />
                  <mat-timepicker #startTimePicker />
                  @if (eventForm.get('startTime')?.hasError('required') &&
                  eventForm.get('startTime')?.touched) {
                  <mat-error>L'heure de début est obligatoire</mat-error>
                  }
                </mat-form-field>
              </div>
            </div>
          </div>
          <div class="col-lg-6 col-md-12">
            <label class="form-label">Fin de l'événement</label>
            <div class="row g-2 align-items-center">
              <div class="col-sm-7">
                <mat-form-field appearance="fill" class="w-100">
                  <mat-label>Date de fin</mat-label>
                  <input
                    matInput
                    [matDatepicker]="endDatePicker"
                    formControlName="endDate"
                    placeholder="Choisir une date"
                    required
                  />
                  <mat-datepicker-toggle
                    matSuffix
                    [for]="endDatePicker"
                    color="primary"
                  ></mat-datepicker-toggle>
                  <mat-datepicker
                    #endDatePicker
                    color="primary"
                    [touchUi]="!isDesktop$()"
                  ></mat-datepicker>
                  @if (eventForm.get('endDate')?.hasError('required') &&
                  eventForm.get('endDate')?.touched) {
                  <mat-error>La date de fin est obligatoire</mat-error>
                  }
                </mat-form-field>
              </div>
              <div class="col-sm-5">
                <mat-form-field appearance="fill" class="w-100">
                  <mat-label>Heure de fin</mat-label>
                  <input
                    matInput
                    [matTimepicker]="endTimePicker"
                    formControlName="endTime"
                    required=""
                  />
                  <mat-timepicker-toggle
                    matIconSuffix
                    [for]="endTimePicker"
                  ></mat-timepicker-toggle>
                  <mat-timepicker
                    #endTimePicker
                    color="primary"
                  ></mat-timepicker>
                  @if (eventForm.get('endTime')?.hasError('required') &&
                  eventForm.get('endTime')?.touched) {
                  <mat-error>L'heure de fin est obligatoire</mat-error>
                  }
                </mat-form-field>
              </div>
            </div>
          </div>
        </div>

        <div class="mb-3">
          <mat-checkbox formControlName="isFreeEvent" color="primary"
            >Événement gratuit</mat-checkbox
          >
        </div>

        <div class="d-flex justify-content-end mt-4">
          <button mat-raised-button matStepperNext color="primary">
            Suivant →
          </button>
        </div>
      </form>
    </mat-step>

    <mat-step [stepControl]="eventForm" label="Emplacement">
      <form [formGroup]="eventForm">
        <div formArrayName="locations" class="mt-3">
          @for (locationGroup of locationControls; track i; let i = $index) {
          <div
            [formGroupName]="i"
            class="location-row d-flex flex-wrap align-items-center justify-content-between gap-3 py-3"
          >
            <div class="location-info flex-shrink-0" style="min-width: 150px">
              <strong>{{ locationGroup.get("name")?.value }}</strong
              ><br />
              <small class="text-muted"
                >Capacité max:
                {{ locationGroup.get("maxCapacity")?.value }}</small
              >
            </div>
            <div
              class="location-inputs d-flex flex-grow-1 gap-3 justify-content-center flex-wrap align-items-center"
            >
              <mat-form-field
                appearance="outline"
                class="flex-fill"
                style="min-width: 180px"
              >
                <mat-label>Nombre de billets</mat-label>
                <input
                  matInput
                  type="number"
                  formControlName="ticketCount"
                  placeholder="Nb. billets"
                  min="0"
                  [max]="locationGroup.get('maxCapacity')?.value"
                />
                @if (locationGroup.get('ticketCount')?.hasError('required') &&
                locationGroup.get('ticketCount')?.touched) {
                <mat-error>Requis si activé</mat-error>
                } @if (locationGroup.get('ticketCount')?.hasError('min') &&
                locationGroup.get('ticketCount')?.touched) {
                <mat-error>Min 0</mat-error>
                } @if (locationGroup.get('ticketCount')?.hasError('max') &&
                locationGroup.get('ticketCount')?.touched) {
                <mat-error
                  >Max {{ locationGroup.get("maxCapacity")?.value }}</mat-error
                >
                }
              </mat-form-field>
              <mat-form-field
                appearance="outline"
                class="flex-fill"
                style="min-width: 150px"
              >
                <mat-label>Prix des billets</mat-label>
                <input
                  matInput
                  type="number"
                  formControlName="ticketPrice"
                  placeholder="Prix"
                  min="0"
                />
                <span matTextSuffix>€</span>
                @if (locationGroup.get('ticketPrice')?.hasError('required') &&
                locationGroup.get('ticketPrice')?.touched) {
                <mat-error>Requis si activé</mat-error>
                } @if (locationGroup.get('ticketPrice')?.hasError('min') &&
                locationGroup.get('ticketPrice')?.touched) {
                <mat-error>Min 0</mat-error>
                }
              </mat-form-field>
            </div>
            <div class="location-toggle flex-shrink-0">
              <mat-slide-toggle formControlName="active" color="primary">
                {{
                  locationGroup.get("active")?.value ? "Activé" : "Désactivé"
                }}
              </mat-slide-toggle>
            </div>
          </div>
          @if (!$last) {
          <mat-divider></mat-divider>
          } } @if (locationControls.length === 0) {
          <p class="text-muted text-center mt-4">
            Aucun emplacement disponible pour cet événement.
          </p>
          } @if (eventForm.get('locations')?.hasError('atLeastOneActive') &&
          eventForm.get('locations')?.touched) {
          <mat-error class="mt-2 text-center d-block"
            >Au moins un emplacement doit être activé.</mat-error
          >
          }
        </div>
        <div
          class="d-flex justify-content-end align-items-center gap-3 mt-2 pt-3 border-top"
        >
          <button mat-button matStepperPrevious class="mt-2">
            ← Précédent
          </button>
          <button mat-raised-button matStepperNext color="primary" class="mt-2">
            Suivant →
          </button>
        </div>
      </form>
    </mat-step>

    <mat-step [stepControl]="eventForm" label="Médias">
      <form [formGroup]="eventForm">
        <div class="row g-3 mb-4 align-items-center mt-3">
          <div class="col-md-6">
            <h5>Photo principale *</h5>
            <div class="d-flex align-items-center gap-3">
              <div
                class="photo-preview border rounded d-flex justify-content-center align-items-center bg-light"
                style="width: 100px; height: 100px"
              >
                @if (mainPhotoPreview) {
                <img
                  [src]="mainPhotoPreview"
                  alt="Aperçu photo principale"
                  style="max-width: 100%; max-height: 100%; object-fit: cover"
                />
                } @else {
                <mat-icon color="primary">image</mat-icon>
                }
              </div>
              <input
                type="file"
                #mainPhotoInput
                hidden
                accept="image/*"
                (change)="onMainPhotoSelected($event)"
              />
              <button
                mat-stroked-button
                color="primary"
                type="button"
                (click)="mainPhotoInput.click()"
              >
                <mat-icon>upload</mat-icon> Choisir photo
              </button>
            </div>
            @if (!mainPhotoFile && eventForm.touched) {
            <mat-error class="mt-2 d-block"
              >La photo principale est requise.</mat-error
            >
            }
          </div>
          <div class="col-md-6">
            <mat-checkbox
              formControlName="displayOnHomepage"
              color="primary"
              class="d-block mb-2"
              >Afficher en page d'accueil</mat-checkbox
            >
            <mat-checkbox
              formControlName="isFeaturedEvent"
              color="primary"
              class="d-block"
              >Événement à la une</mat-checkbox
            >
          </div>
        </div>

        <div class="row g-3 mb-4">
          <div class="col-md-6">
            <h5>Photos de l'événement (max {{ MAX_PHOTOS }})</h5>
            <input
              type="file"
              #eventPhotosInput
              hidden
              multiple
              accept="image/*"
              (change)="onEventPhotosSelected($event)"
            />
            <button
              mat-stroked-button
              color="primary"
              type="button"
              (click)="eventPhotosInput.click()"
              [disabled]="selectedEventPhotos.length >= MAX_PHOTOS"
            >
              <mat-icon>add_photo_alternate</mat-icon> Ajouter des photos
            </button>
            @if (selectedEventPhotos.length >= MAX_PHOTOS) {
            <mat-hint class="ms-2">Limite de photos atteinte.</mat-hint>
            } @if (selectedEventPhotos.length > 0) {
            <mat-list dense class="mt-2 border rounded p-2 selected-files-list">
              @for (file of selectedEventPhotos; track i; let i = $index) {
              <mat-list-item>
                <mat-icon matListItemIcon>image</mat-icon>
                <div matListItemTitle class="small text-truncate">
                  {{ file.name }}
                </div>
                <div matListItemLine class="small text-muted">
                  {{ (file.size / 1024).toFixed(1) }} Ko
                </div>
                <button
                  mat-icon-button
                  color="warn"
                  type="button"
                  (click)="removeSelectedPhoto(i)"
                  aria-label="Supprimer cette photo"
                >
                  <mat-icon>delete</mat-icon>
                </button>
              </mat-list-item>
              }
            </mat-list>
            }
          </div>

          <div class="col-md-6">
            <h5>Liens utiles</h5>
            <div formArrayName="links">
              @for (linkControl of linkControls; track i; let i = $index) {
              <div class="d-flex align-items-start gap-2 mb-2">
                <mat-form-field appearance="outline" class="flex-grow-1">
                  <mat-label>Lien {{ $index + 1 }}</mat-label>
                  <input
                    matInput
                    [formControlName]="i"
                    placeholder="http:// ou https://"
                  />
                  @if (linkControl.hasError('pattern') && linkControl.touched) {
                  <mat-error>URL invalide</mat-error>
                  }
                </mat-form-field>
                <button
                  mat-icon-button
                  color="warn"
                  type="button"
                  (click)="removeLink(i)"
                  [disabled]="linkControls.length <= 1"
                  aria-label="Supprimer ce lien"
                >
                  <mat-icon>remove_circle_outline</mat-icon>
                </button>
              </div>
              }
            </div>
            <button
              mat-stroked-button
              color="primary"
              type="button"
              (click)="addLink()"
            >
              <mat-icon>add</mat-icon> Ajouter un lien
            </button>
          </div>
        </div>

        <div class="row g-3 mb-3">
          <div class="col-12">
            <mat-form-field appearance="fill" class="w-100" floatLabel="always">
              <mat-label>Description complète</mat-label>
              <textarea
                matInput
                formControlName="fullDescription"
                placeholder="Entrez la description détaillée de l'événement ici..."
                rows="6"
              ></textarea>
              @if (eventForm.get('fullDescription')?.hasError('required') &&
              eventForm.get('fullDescription')?.touched) {
              <mat-error>La description complète est requise.</mat-error>
              } @if (eventForm.get('fullDescription')?.hasError('maxlength') &&
              eventForm.get('fullDescription')?.touched) {
              <mat-error
                >La description ne peut pas dépasser 1000 caractères</mat-error
              >
              }
            </mat-form-field>
          </div>
        </div>

        <div
          class="d-flex justify-content-end align-items-center gap-3 mt-2 pt-3 border-top"
        >
          <button mat-button matStepperPrevious class="mt-2">
            ← Précédent
          </button>

          <mat-slide-toggle
            formControlName="saveAsDraft"
            color="primary"
            class="mt-2"
          >
            Enregistrer comme brouillon
          </mat-slide-toggle>

          <button
            mat-raised-button
            color="primary"
            (click)="onSubmit()"
            [disabled]="
              eventForm.invalid ||
              (!mainPhotoFile && !eventForm.get('saveAsDraft')?.value)
            "
            class="mt-2"
          >
            <mat-icon>save</mat-icon>
            {{
              eventForm.get("saveAsDraft")?.value
                ? "Enregistrer le brouillon"
                : "Enregistrer et Publier"
            }}
          </button>
        </div>
      </form>
    </mat-step>
  </mat-stepper>
</div>
