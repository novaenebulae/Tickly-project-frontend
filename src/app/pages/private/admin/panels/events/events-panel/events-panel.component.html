<div class="container-fluid py-3 events-panel-page">

  <mat-card class="mat-elevation-z2 mb-4">
    <mat-card-content
      class="d-flex justify-content-between align-items-start flex-wrap gap-3 p-4"
    >
      <div class="d-flex-column">
        <h1 class="mat-headline-3 mb-1">Tous les événements</h1>
        <p class="mat-body-3 text-muted w-70 mt-1">
          Liste des événements créés pour la structure
        </p>
      </div>
      <div class="d-flex align-items-center gap-3">
        <!-- Liaison à isListView -->
        <mat-slide-toggle color="primary" [(ngModel)]="isListView" aria-label="Basculer en vue liste">
          Affichage en liste
        </mat-slide-toggle>
        <!-- Appel à onAddEvent -->
        <button mat-raised-button color="primary" (click)="onAddEvent()">
          <mat-icon>add</mat-icon>
          Ajouter un événement
        </button>
      </div>

      <!-- Barre de filtres et recherche -->
      <div class="mat-elevation-z2 container-fluid mt-3">
        <div class="d-flex flex-wrap gap-3 align-items-center">
          <!-- Bouton Filtres avec Menu -->
          <button mat-stroked-button class="bg-light-subtle filter-button" [matMenuTriggerFor]="filterMenu"
                  color="primary">
            Filtres par Statut
            <mat-icon>filter_list</mat-icon>
          </button>
          <!-- Sélecteur de Tri (liaison à sortOption, appel processEvents) -->
          <mat-form-field appearance="outline" class="filter-select bg-light-subtle" subscriptSizing="dynamic">
            <mat-label>Trier par</mat-label>
            <mat-select [(ngModel)]="sortOption" (selectionChange)="processEvents()">
              <mat-option value="dateAsc">Date (Prochain en premier)</mat-option>
              <mat-option value="dateDesc">Date (Plus récent en premier)</mat-option>
              <mat-option value="nameAsc">Nom (A-Z)</mat-option>
              <mat-option value="nameDesc">Nom (Z-A)</mat-option>
            </mat-select>
          </mat-form-field>


          <!-- Champ de Recherche (liaison à searchTerm, appel onSearchTermChange, réf #filterInput) -->
          <mat-form-field appearance="outline" class="flex-grow-1 min-w-200 bg-light-subtle" subscriptSizing="dynamic">
            <mat-label>Rechercher un événement...</mat-label>
            <mat-icon matPrefix class="icon-muted me-2">search</mat-icon>
            <input matInput type="search" [(ngModel)]="searchTerm" (input)="onSearchTermChange()"
                   placeholder="Nom, type, lieu..." #filterInput>
            <!-- Bouton effacer (condition searchTerm, appel clearSearch) -->
            @if (searchTerm) {
              <button matSuffix mat-icon-button aria-label="Effacer la recherche" (click)="clearSearch()">
                <mat-icon>close</mat-icon>
              </button>
            }
          </mat-form-field>

          <!-- Menu contenant les Checkboxes de filtre (liaison à filterStatus.STATUS, appel processEvents) -->
          <mat-menu #filterMenu="matMenu" class="filter-status-menu bg-light-subtle">
            <mat-checkbox class="mat-menu-item" [(ngModel)]="filterStatus.PUBLISHED" (ngModelChange)="processEvents()">
              Publiés
            </mat-checkbox>
            <mat-checkbox class="mat-menu-item" [(ngModel)]="filterStatus.ONGOING" (ngModelChange)="processEvents()">En
              cours
            </mat-checkbox>
            <mat-checkbox class="mat-menu-item" [(ngModel)]="filterStatus.PAST" (ngModelChange)="processEvents()">
              Passés
            </mat-checkbox>
            <mat-checkbox class="mat-menu-item" [(ngModel)]="filterStatus.DRAFT" (ngModelChange)="processEvents()">
              Brouillons
            </mat-checkbox>
            <mat-checkbox class="mat-menu-item" [(ngModel)]="filterStatus.CANCELLED" (ngModelChange)="processEvents()">
              Annulés
            </mat-checkbox>
          </mat-menu>
        </div>
        <!-- Compteur de résultats (utilise filteredEvents.length) -->
        <div class="ms-auto fw-medium text-muted justify-content-end mt-3 w-100 d-flex">
          {{ filteredEvents.length }} résultat{{ filteredEvents.length !== 1 ? 's' : '' }}
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Indicateur de chargement (condition isLoading) -->
  @if (isLoading) {
    <div class="text-center my-5 d-flex flex-column align-items-center justify-content-center">
      <mat-progress-spinner mode="indeterminate" diameter="100"></mat-progress-spinner>
      <p class="mt-5 text-muted">Chargement des événements...</p>
    </div>
  }

  <!-- Message si erreur (condition error) -->
  @if (error) {
    <mat-card class="mat-elevation-z0 border border-danger text-danger p-3 my-4">
      <mat-card-content class="d-flex align-items-center gap-2">
        <mat-icon>error_outline</mat-icon>
        <span>{{ error }}</span>
      </mat-card-content>
    </mat-card>
  }

  <!-- Affichage des événements (condition !isLoading && !error) -->
  @if (!isLoading && !error) {
    <!-- Boucle sur les groupes de dates (variable groupedEvents, track dateString) -->
    @for (group of groupedEvents; track group.dateString) {
      <h3 class="mat-subheader mt-4 mb-2 event-group-header">{{ group.date | date:'EEEE d MMMM yyyy' }}</h3>

      <!-- Conteneur pour la VUE LISTE (condition isListView) -->
      @if (isListView) {
        <div class="list-view">
          <!-- Boucle sur les événements du groupe (variable event, track event.id) -->
          @for (event of group.events; track $index) {
            <mat-card class="mb-3 event-card list-card mat-elevation-z1 hover-shadow">
              <mat-card-content class="p-0">
                <div class="d-flex flex-column flex-md-row align-items-stretch">
                  <!-- Colonne Image (utilise event.imageUrl, defaultImage) -->
                  <div class="list-image-container">
                    <img [src]="event.imageUrl ? event.imageUrl : defaultImage" alt="Image {{ event.title }}"
                         class="event-image">
                  </div>
                  <!-- Colonne Infos Principales -->
                  <div class="flex-grow-1 p-3 d-flex flex-column">
                    <h4 class="mat-title mb-1 event-title">{{ event.title }}</h4>
                    <div class="event-info d-flex flex-wrap gap-x-3 gap-y-1 text-muted mat-body-2 mb-2">
                      <span><mat-icon class="icon-sm">event</mat-icon>
                        {{ event.date | date:'dd/MM/yy HH:mm' }}</span>
                      <span><mat-icon class="icon-sm">place</mat-icon>
                        {{ event.location }}</span>
                      <span><mat-icon class="icon-sm">category</mat-icon>
                        {{ event.type }}</span>
                    </div>
                    <div class="mt-auto d-flex justify-content-between align-items-center">
                      <!-- Statut (appelle getStatusColor, getStatusText) -->
                      <mat-chip-listbox class="event-status">
                        <mat-chip [color]="getStatusColor(event.status)" density="-2" selected disabled>
                          {{ getStatusText(event.status) }}
                        </mat-chip>
                      </mat-chip-listbox>
                    </div>
                  </div>
                  <!-- Colonne Actions -->
                  <div class="event-actions d-flex align-items-center p-3 border-start-md">
                    <!-- Appels showParticipants, showStats, openEventPage -->
                    <button mat-icon-button color="primary" matTooltip="Afficher les participants"
                            (click)="showParticipants(event)" aria-label="Afficher les participants">
                      <mat-icon>people</mat-icon>
                    </button>
                    <button mat-icon-button color="primary" matTooltip="Afficher les statistiques"
                            (click)="showStats(event)" aria-label="Afficher les statistiques">
                      <mat-icon>bar_chart</mat-icon>
                    </button>
                    <button mat-icon-button color="primary" matTooltip="Voir la page web" (click)="openEventPage(event)"
                            [disabled]="!event.webPageUrl" aria-label="Voir la page web">
                      <mat-icon>public</mat-icon>
                    </button>
                    <!-- Menu Actions CRUD (appelle editEvent, duplicateEvent, cancelEvent) -->
                    <button mat-icon-button [matMenuTriggerFor]="actionsMenu" matTooltip="Plus d'actions"
                            aria-label="Plus d'actions">
                      <mat-icon>more_vert</mat-icon>
                    </button>
                    <mat-menu #actionsMenu="matMenu">
                      <button mat-menu-item (click)="editEvent(event)">
                        <mat-icon>edit</mat-icon>
                        Modifier
                      </button>
                      <button mat-menu-item (click)="duplicateEvent(event)">
                        <mat-icon>content_copy</mat-icon>
                        Dupliquer
                      </button>
                      <!-- Condition pour Annuler -->
                      @if (event.status !== 'PAST' && event.status !== 'CANCELLED') {
                        <button mat-menu-item (click)="cancelEvent(event)">
                          <mat-icon color="warn">cancel</mat-icon>
                          Annuler
                        </button>
                      }
                    </mat-menu>
                  </div>
                </div>
              </mat-card-content>
            </mat-card>
          }
        </div>
      } @else {
        <!-- Conteneur pour la VUE GRILLE -->
        <div class="grid-view row g-3">
          @for (event of group.events; track $index) {
            <div class="col-12 col-md-6 col-lg-4 col-xl-3 d-flex">
              <mat-card class="event-card grid-card mat-elevation-z1 hover-shadow w-100">
                <img mat-card-image [src]="event.imageUrl ? event.imageUrl : defaultImage" alt="Image {{ event.title }}"
                     class="grid-event-image">
                <mat-card-header>
                  <mat-card-title class="mat-title mb-0">{{ event.title }}</mat-card-title>
                  <mat-card-subtitle>
                    <mat-icon class="icon-sm">event</mat-icon>
                    {{ event.date | date:'dd/MM/yy HH:mm' }}
                  </mat-card-subtitle>
                </mat-card-header>
                <mat-card-content class="d-flex flex-column flex-grow-1">
                  <div class="event-info d-flex flex-column gap-1 text-muted mat-body-2 mb-auto">
                    <span><mat-icon class="icon-sm">place</mat-icon>
                      {{ event.location }}</span>
                    <span><mat-icon class="icon-sm">category</mat-icon>
                      {{ event.type }}</span>
                  </div>
                  <!-- Statut (appelle getStatusColor, getStatusText) -->
                  <mat-chip-listbox class="event-status mt-2">
                    <mat-chip [color]="getStatusColor(event.status)" density="-2" selected disabled>
                      {{ getStatusText(event.status) }}
                    </mat-chip>
                  </mat-chip-listbox>
                </mat-card-content>
                <!-- Actions carte grille (appelle showParticipants, etc.) -->
                <mat-card-actions class="grid-actions justify-content-end">
                  <button mat-icon-button color="primary" matTooltip="Afficher les participants"
                          (click)="showParticipants(event)" aria-label="Afficher les participants">
                    <mat-icon>people</mat-icon>
                  </button>
                  <button mat-icon-button color="primary" matTooltip="Afficher les statistiques"
                          (click)="showStats(event)" aria-label="Afficher les statistiques">
                    <mat-icon>bar_chart</mat-icon>
                  </button>
                  <button mat-icon-button color="primary" matTooltip="Voir la page web" (click)="openEventPage(event)"
                          [disabled]="!event.webPageUrl" aria-label="Voir la page web">
                    <mat-icon>public</mat-icon>
                  </button>
                  <button mat-icon-button [matMenuTriggerFor]="actionsMenuGrid" matTooltip="Plus d'actions"
                          aria-label="Plus d'actions">
                    <mat-icon>more_vert</mat-icon>
                  </button>
                  <mat-menu #actionsMenuGrid="matMenu">
                    <button mat-menu-item (click)="editEvent(event)">
                      <mat-icon>edit</mat-icon>
                      Modifier
                    </button>
                    <button mat-menu-item (click)="duplicateEvent(event)">
                      <mat-icon>content_copy</mat-icon>
                      Dupliquer
                    </button>
                    @if (event.status !== 'PAST' && event.status !== 'CANCELLED') {
                      <button mat-menu-item (click)="cancelEvent(event)">
                        <mat-icon color="warn">cancel</mat-icon>
                        Annuler
                      </button>
                    }
                  </mat-menu>
                </mat-card-actions>
              </mat-card>
            </div>
          }
        </div>
      }
    } @empty {
      <!-- Message si aucun événement (condition !isLoading && !error) -->
      @if (!isLoading && !error) {
        <mat-card class="mat-elevation-z0 border text-muted p-3 my-4 text-center">
          <mat-card-content>
            <mat-icon class="large-icon">sentiment_dissatisfied</mat-icon>
            <p class="mt-2">Aucun événement ne correspond à vos critères actuels.</p>
            <!-- Bouton Réinitialiser (appelle resetFilters) -->
            <button mat-stroked-button (click)="resetFilters()">Réinitialiser les filtres</button>
          </mat-card-content>
        </mat-card>
      }
    }
  }

</div>
