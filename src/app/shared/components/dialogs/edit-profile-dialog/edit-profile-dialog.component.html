<div class="edit-profile-dialog">
  <div mat-dialog-title>
    <h2>Modifier mon profil</h2>
  </div>

  <mat-dialog-content>
    <mat-tab-group>
      <!-- Onglet Informations du profil -->
      <mat-tab label="Informations">
        <div class="tab-content">
          <!-- En-tête avec avatar -->
          <div class="profile-header">
            <div class="avatar-container">
              <div class="avatar" [style.background-image]="'url(' + profileAvatarUrl() + ')'"></div>
            </div>
            <div class="user-info">
              <h3>{{ data.user.firstName }} {{ data.user.lastName }}</h3>
              <p>{{ data.user.email }}</p>
              <p class="role-badge">{{ data.user.role }}</p>
            </div>
          </div>

          <!-- Formulaire d'édition de profil -->
          <form [formGroup]="profileForm" (ngSubmit)="submitProfileChanges()">
            <div class="form-row">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Prénom</mat-label>
                <input
                  matInput
                  formControlName="firstName"
                  placeholder="Votre prénom"
                  (input)="updateAvatarPreview()"
                  required
                />
                @if (profileForm.get('firstName')?.hasError('required') && profileForm.get('firstName')?.touched) {
                  <mat-error>Le prénom est obligatoire</mat-error>
                }
                @if (profileForm.get('firstName')?.hasError('minlength')) {
                  <mat-error>Le prénom doit comporter au moins 2 caractères</mat-error>
                }
              </mat-form-field>

              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Nom</mat-label>
                <input
                  matInput
                  formControlName="lastName"
                  placeholder="Votre nom"
                  (input)="updateAvatarPreview()"
                  required
                />
                @if (profileForm.get('lastName')?.hasError('required') && profileForm.get('lastName')?.touched) {
                  <mat-error>Le nom est obligatoire</mat-error>
                }
                @if (profileForm.get('lastName')?.hasError('minlength')) {
                  <mat-error>Le nom doit comporter au moins 2 caractères</mat-error>
                }
              </mat-form-field>
            </div>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Email</mat-label>
              <input
                matInput
                formControlName="email"
                placeholder="Votre email"
                type="email"
                required
              />
              @if (profileForm.get('email')?.hasError('required') && profileForm.get('email')?.touched) {
                <mat-error>L'adresse email est obligatoire</mat-error>
              }
              @if (profileForm.get('email')?.hasError('email')) {
                <mat-error>Veuillez saisir une adresse email valide</mat-error>
              }
            </mat-form-field>

            <div class="actions-container">
              <button
                type="button"
                mat-stroked-button
                (click)="cancel()"
                [disabled]="isUpdatingProfile()">
                Annuler
              </button>
              <button
                type="submit"
                mat-raised-button
                color="primary"
                [disabled]="profileForm.invalid || !isProfileFormChanged || isUpdatingProfile()">
                @if (!isUpdatingProfile()) {
                  Enregistrer
                } @else {
                  <mat-spinner diameter="24"></mat-spinner>
                }
              </button>
            </div>
          </form>
        </div>
      </mat-tab>

      <!-- Onglet Changement de mot de passe -->
      <mat-tab label="Mot de passe">
        <div class="tab-content">
          <div class="password-info">
            <mat-icon>info</mat-icon>
            <span>Votre mot de passe doit comporter au moins 8 caractères.</span>
          </div>

          <form [formGroup]="passwordForm" (ngSubmit)="changePassword()">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Mot de passe actuel</mat-label>
              <input
                matInput
                formControlName="currentPassword"
                placeholder="Votre mot de passe actuel"
                [type]="showPassword() ? 'text' : 'password'"
                required
              />
              <button
                mat-icon-button
                matSuffix
                type="button"
                (click)="togglePasswordVisibility('password')"
                [attr.aria-label]="'Afficher le mot de passe'">
                <mat-icon>{{ showPassword() ? 'visibility_off' : 'visibility' }}</mat-icon>
              </button>
              @if (passwordForm.get('currentPassword')?.hasError('required') && passwordForm.get('currentPassword')?.touched) {
                <mat-error>Le mot de passe actuel est obligatoire</mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Nouveau mot de passe</mat-label>
              <input
                matInput
                formControlName="newPassword"
                placeholder="Votre nouveau mot de passe"
                [type]="showNewPassword() ? 'text' : 'password'"
                required
              />
              <button
                mat-icon-button
                matSuffix
                type="button"
                (click)="togglePasswordVisibility('newPassword')"
                [attr.aria-label]="'Afficher le nouveau mot de passe'">
                <mat-icon>{{ showNewPassword() ? 'visibility_off' : 'visibility' }}</mat-icon>
              </button>
              @if (passwordForm.get('newPassword')?.hasError('required') && passwordForm.get('newPassword')?.touched) {
                <mat-error>Le nouveau mot de passe est obligatoire</mat-error>
              }
              @if (passwordForm.get('newPassword')?.hasError('minlength')) {
                <mat-error>Le mot de passe doit comporter au moins 8 caractères</mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Confirmer le mot de passe</mat-label>
              <input
                matInput
                formControlName="confirmPassword"
                placeholder="Confirmez votre nouveau mot de passe"
                [type]="showConfirmPassword() ? 'text' : 'password'"
                required
              />
              <button
                mat-icon-button
                matSuffix
                type="button"
                (click)="togglePasswordVisibility('confirmPassword')"
                [attr.aria-label]="'Afficher la confirmation du mot de passe'">
                <mat-icon>{{ showConfirmPassword() ? 'visibility_off' : 'visibility' }}</mat-icon>
              </button>
              @if (passwordForm.get('confirmPassword')?.hasError('required') && passwordForm.get('confirmPassword')?.touched) {
                <mat-error>La confirmation du mot de passe est obligatoire</mat-error>
              }
              @if (passwordForm.hasError('passwordMismatch') && !passwordForm.get('confirmPassword')?.hasError('required')) {
                <div class="form-error">Les mots de passe ne correspondent pas</div>
              }
            </mat-form-field>

            <div class="actions-container">
              <button
                type="button"
                mat-stroked-button
                (click)="cancel()"
                [disabled]="isChangingPassword()">
                Annuler
              </button>
              <button
                type="submit"
                mat-raised-button
                color="primary"
                [disabled]="passwordForm.invalid || isChangingPassword()">
                @if (!isChangingPassword()) {
                  Changer le mot de passe
                } @else {
                  <mat-spinner diameter="24"></mat-spinner>
                }
              </button>
            </div>
          </form>
        </div>
      </mat-tab>
    </mat-tab-group>
  </mat-dialog-content>
  <mat-dialog-actions align="end">
    <button mat-button (click)="cancel()">Annuler</button>
  </mat-dialog-actions>
</div>
