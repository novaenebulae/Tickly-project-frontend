
<h2 mat-dialog-title>Gestion des Amis</h2>
<div mat-dialog-content>
  <mat-tab-group>
    <!-- Onglet Mes Amis -->
    <mat-tab label="Mes Amis">
      @if (isLoadingFriends()) {
        <div class="spinner-container">
          <mat-spinner diameter="40"></mat-spinner>
        </div>
      } @else if (friends().length > 0) {
        <mat-list>
          @for (friend of friends(); track friend.id) {
            <mat-list-item class="friend-list-item">
              <div class="friend-avatar" [style.background-image]="'url(' + (friend.avatarUrl || 'assets/images/default-avatar.png') + ')'">
                <div class="status-indicator" [class.online]="friend.isOnline"></div>
              </div>
              <div class="friend-info">
                <div class="friend-name">{{ friend.firstName }} {{ friend.lastName }}</div>
                <div class="friend-status">{{ friend.isOnline ? 'En ligne' : 'Hors ligne' }}</div>
              </div>
              <button mat-icon-button [matMenuTriggerFor]="friendMenu" aria-label="Actions">
                <mat-icon>more_vert</mat-icon>
              </button>
              <mat-menu #friendMenu="matMenu">
                <button mat-menu-item>
                  <mat-icon>message</mat-icon>
                  <span>Envoyer un message</span>
                </button>
                <button mat-menu-item (click)="removeFriend(friend.friendshipId)">
                  <mat-icon>person_remove</mat-icon>
                  <span>Supprimer de mes amis</span>
                </button>
              </mat-menu>
            </mat-list-item>
            <mat-divider *ngIf="!$last"></mat-divider>
          }
        </mat-list>
      } @else {
        <div class="empty-state">
          <mat-icon>people_outline</mat-icon>
          <p>Vous n'avez pas encore d'amis. Utilisez l'onglet "Ajouter un ami" pour envoyer des invitations.</p>
        </div>
      }
    </mat-tab>

    <!-- Onglet Demandes -->
    <mat-tab label="Demandes" [disabled]="pendingRequests().length === 0">
      @if (isLoadingRequests()) {
        <div class="spinner-container">
          <mat-spinner diameter="40"></mat-spinner>
        </div>
      } @else if (pendingRequests().length > 0) {
        <mat-list>
          @for (request of pendingRequests(); track request.id) {
            <mat-list-item class="request-list-item">
              <div class="friend-avatar" [style.background-image]="'url(' + (request.user.avatarUrl || 'assets/images/default-avatar.png') + ')'"></div>
              <div class="friend-info">
                <div class="friend-name">{{ request.user.firstName }} {{ request.user.lastName }}</div>
                <div class="request-date">Demande envoyée le {{ request.createdAt | date:'dd/MM/yyyy' }}</div>
              </div>
              <div class="request-actions">
                <button mat-icon-button color="primary" (click)="acceptRequest(request.id)" matTooltip="Accepter">
                  <mat-icon>check</mat-icon>
                </button>
                <button mat-icon-button color="warn" (click)="rejectRequest(request.id)" matTooltip="Refuser">
                  <mat-icon>close</mat-icon>
                </button>
              </div>
            </mat-list-item>
            <mat-divider *ngIf="!$last"></mat-divider>
          }
        </mat-list>
      } @else {
        <div class="empty-state">
          <mat-icon>notifications_none</mat-icon>
          <p>Vous n'avez pas de nouvelles demandes d'amitié.</p>
        </div>
      }
    </mat-tab>

    <!-- Onglet Demandes Envoyées -->
    <mat-tab label="Envoyées" [disabled]="sentRequests().length === 0">
      @if (sentRequests().length > 0) {
        <mat-list>
          @for (request of sentRequests(); track request.id) {
            <mat-list-item class="sent-request-item">
              <div class="friend-avatar" [style.background-image]="'url(' + (request.user.avatarUrl || 'assets/images/default-avatar.png') + ')'"></div>
              <div class="friend-info">
                <div class="friend-name">{{ request.user.firstName }} {{ request.user.lastName }}</div>
                <div class="request-date">Envoyée le {{ request.createdAt | date:'dd/MM/yyyy' }}</div>
                <div class="request-status">
                  <mat-icon [ngClass]="{'pending': request.status === 'pending', 'accepted': request.status === 'accepted', 'rejected': request.status === 'rejected'}">
                    {{ request.status === 'pending' ? 'pending' : (request.status === 'accepted' ? 'check_circle' : 'cancel') }}
                  </mat-icon>
                  {{ request.status === 'pending' ? 'En attente' : (request.status === 'accepted' ? 'Acceptée' : 'Rejetée') }}
                </div>
              </div>
            </mat-list-item>
            <mat-divider *ngIf="!$last"></mat-divider>
          }
        </mat-list>
      } @else {
        <div class="empty-state">
          <mat-icon>send</mat-icon>
          <p>Vous n'avez pas envoyé de demandes d'amitié.</p>
        </div>
      }
    </mat-tab>

    <!-- Onglet Ajouter un ami -->
    <mat-tab label="Ajouter un ami">
      <div class="add-friend-container">
        <div class="info-message mb-3">
          <mat-icon>info</mat-icon>
          <p>Saisissez l'adresse email de la personne que vous souhaitez ajouter comme ami.</p>
        </div>

        <form [formGroup]="addFriendForm" (ngSubmit)="sendFriendRequestByEmail()">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Adresse email</mat-label>
            <input
              matInput
              formControlName="email"
              placeholder="exemple@mail.com"
              type="email"
              required
            >
            <mat-icon matPrefix>email</mat-icon>

            @if (addFriendForm.get('email')?.hasError('required') && addFriendForm.get('email')?.touched) {
              <mat-error>L'adresse email est obligatoire</mat-error>
            }
            @if (addFriendForm.get('email')?.hasError('email')) {
              <mat-error>Veuillez saisir une adresse email valide</mat-error>
            }
          </mat-form-field>

          <div class="actions-container">
            <button
              type="submit"
              mat-raised-button
              color="primary"
              [disabled]="addFriendForm.invalid || isSendingRequest()">
              @if (!isSendingRequest()) {
                <mat-icon>person_add</mat-icon>
                Envoyer une demande d'amitié
              } @else {
                <mat-spinner diameter="24"></mat-spinner>
              }
            </button>
          </div>
        </form>
      </div>
    </mat-tab>
  </mat-tab-group>
</div>

<div mat-dialog-actions align="end">
  <button mat-button (click)="close()">Fermer</button>
</div>
